⏺ F1 比赛后数据同步完整使用指南

📋 概述

本指南将详细说明如何使用两个新创建的双数据库同步脚本来更新 F1 比赛数据。这两个脚本可以同时将最新的比赛数据同步到
本地数据库和 Render 云数据库。

🎯 脚本介绍

1. dual_database_sync.py (简单版 - 推荐日常使用)

- 特点: 一键同步所有数据到两个数据库
- 优点: 操作简单，无需参数
- 适用: 比赛后的常规数据更新

2. smart_sync.py (智能版 - 高级用户)

- 特点: 支持灵活配置和选择性同步
- 优点: 可自定义同步选项
- 适用: 需要精确控制同步内容时

🛠️ 环境准备

前置条件检查

在使用脚本前，请确保满足以下条件：

# 1. 检查 Docker 是否运行（本地数据库需要）

docker ps | grep f1_postgres

# 如果没有运行，启动 Docker 容器

cd /Users/liangnuanhui/Documents/F1-web
docker-compose up -d

# 2. 检查 Poetry 环境

cd /Users/liangnuanhui/Documents/F1-web/backend
poetry --version

# 3. 验证脚本存在

ls -la scripts/dual_database_sync.py scripts/smart_sync.py

🚀 使用方法详解

方法一：简单版脚本 (dual_database_sync.py)

基本使用

cd /Users/liangnuanhui/Documents/F1-web/backend

# 一键同步所有数据到本地和 Render 数据库

poetry run python scripts/dual_database_sync.py

执行过程说明

脚本会依次执行以下操作：

1. 连接本地数据库，同步以下数据：

   - ✅ 车手积分榜 (Driver Standings)
   - ✅ 车队积分榜 (Constructor Standings)
   - ✅ 比赛结果 (Race Results)
   - ✅ 排位赛结果 (Qualifying Results)
   - ✅ 冲刺赛结果 (Sprint Results)

2. 连接 Render 数据库，同步相同的数据
3. 输出同步结果总结

预期输出示例

2025-07-28 14:30:00,123 - INFO - 🚀 开始同步数据到 本地 数据库...
2025-07-28 14:30:05,456 - INFO - ✅ 本地: 车手积分榜同步成功
2025-07-28 14:30:10,789 - INFO - ✅ 本地: 车队积分榜同步成功
...
2025-07-28 14:35:00,123 - INFO - 🚀 开始同步数据到 Render 数据库...
...
==================================================
📊 双数据库同步结果总结:
本地数据库: ✅ 成功
Render 数据库: ✅ 成功
🎉 双数据库同步全部成功！

方法二：智能版脚本 (smart_sync.py)

查看帮助信息

poetry run python scripts/smart_sync.py --help

常用命令示例

1. 标准使用（等同于简单版）

# 同步所有数据到两个数据库

poetry run python scripts/smart_sync.py

2. 选择性数据同步

# 只同步积分榜数据

poetry run python scripts/smart_sync.py --data-types drivers constructors

# 只同步比赛相关结果

poetry run python scripts/smart_sync.py -t race qualifying sprint

# 只同步车手积分榜

poetry run python scripts/smart_sync.py -t drivers

3. 选择性数据库同步

# 只同步到本地数据库

poetry run python scripts/smart_sync.py --databases local

# 只同步到 Render 数据库

poetry run python scripts/smart_sync.py -d render

# 同步到两个数据库（默认）

poetry run python scripts/smart_sync.py -d both

4. 不同赛季数据同步

# 同步 2024 赛季数据

poetry run python scripts/smart_sync.py --season 2024

# 同步 2023 赛季数据

poetry run python scripts/smart_sync.py -s 2023

5. 组合使用

# 只同步 2025 赛季的车手和车队积分榜到本地数据库，显示详细日志

poetry run python scripts/smart_sync.py -d local -s 2025 -t drivers constructors -v

📅 标准使用流程

每次比赛后的标准操作流程

步骤 1：确保环境准备就绪

cd /Users/liangnuanhui/Documents/F1-web/backend

# 启动本地 Docker 数据库

docker-compose up -d

# 等待数据库启动完成（约 10-15 秒）

sleep 15

步骤 2：执行数据同步

# 推荐使用简单版（一条命令搞定）

poetry run python scripts/dual_database_sync.py

步骤 3：验证同步结果

# 检查本地 API 是否有最新数据（如果本地 API 在运行）

curl -s "http://localhost:8000/api/v1/standings/drivers?season_year=2025" | head -10

# 检查 Render API 是否有最新数据

curl -s "https://f1-web-api.onrender.com/api/v1/standings/drivers?season_year=2025" | head -10

🚨 故障排除

常见问题及解决方案

1. Docker 数据库连接失败

错误信息: connection to server at "localhost", port 5432 failed

解决方案:

# 检查 Docker 容器状态

docker ps | grep postgres

# 重启 Docker 容器

docker-compose down
docker-compose up -d

# 等待数据库完全启动

sleep 20

2. Render 数据库连接超时

错误信息: timeout expired 或 connection timed out

解决方案:

# 只同步到本地数据库，稍后单独同步 Render

poetry run python scripts/smart_sync.py -d local

# 稍后重试 Render 数据库

poetry run python scripts/smart_sync.py -d render

3. 部分数据同步失败

错误信息: ❌ XXX 数据库: XXX 同步失败

解决方案:

# 使用智能版只同步失败的数据类型

# 例如：如果冲刺赛结果同步失败

poetry run python scripts/smart_sync.py -t sprint -v

# 查看详细错误日志

poetry run python scripts/smart_sync.py --verbose

4. 权限问题

错误信息: permission denied 或 authentication failed

解决方案:

# 检查脚本权限

chmod +x scripts/dual_database_sync.py scripts/smart_sync.py

# 检查数据库连接字符串是否正确

# 确保 Render 数据库 URL 没有过期

📊 最佳实践建议

1. 定期使用流程

# 每个比赛周末后的标准流程

cd /Users/liangnuanhui/Documents/F1-web/backend
docker-compose up -d
sleep 15
poetry run python scripts/dual_database_sync.py

2. 赛季开始前的测试

# 测试脚本是否正常工作

poetry run python scripts/smart_sync.py -t drivers -v

3. 紧急情况处理

# 如果某个数据库连接有问题，分别同步

poetry run python scripts/smart_sync.py -d local
poetry run python scripts/smart_sync.py -d render

4. 数据验证

# 同步后验证数据是否正确更新

curl -s "https://f1-web-api.onrender.com/api/v1/standings/drivers?season_year=2025" | python3 -c "
import json, sys
data = json.load(sys.stdin)
if data.get('success'):
print(f'前 3 名: {[d[\"driver_name\"] + \" \" + str(d[\"points\"]) + \"分\" for d in data[\"data\"][:3]]}')
"

🎯 脚本选择指南

什么时候使用简单版 (dual_database_sync.py)

- ✅ 比赛刚结束，需要更新所有数据
- ✅ 日常维护，保持数据同步
- ✅ 不需要特殊配置的情况
- ✅ 快速操作，一条命令搞定

什么时候使用智能版 (smart_sync.py)

- ✅ 只需要更新某些特定数据（如只要积分榜）
- ✅ 某个数据库有问题，需要单独同步
- ✅ 需要同步历史赛季数据
- ✅ 需要详细日志进行问题排查
- ✅ 在不同环境下测试

📝 创建快捷命令（可选）

为了更方便使用，你可以创建别名：

# 在 ~/.zshrc 或 ~/.bashrc 中添加

alias f1sync="cd /Users/liangnuanhui/Documents/F1-web/backend && docker-compose up -d && sleep 15 && poetry
run python scripts/dual_database_sync.py"
alias f1smart="cd /Users/liangnuanhui/Documents/F1-web/backend && poetry run python scripts/smart_sync.py"

# 重新加载配置

source ~/.zshrc # 或 source ~/.bashrc

这样你就可以简单地使用：

# 一条命令完成所有操作

f1sync

# 使用智能版

f1smart -t drivers constructors

🎉 总结

- 日常使用: poetry run python scripts/dual_database_sync.py
- 灵活配置: poetry run python scripts/smart_sync.py [选项]
- 记住: 先启动 Docker，再执行同步
- 验证: 同步后检查 API 返回的数据是否最新

这两个脚本为你提供了完整的 F1 数据同步解决方案，既有简单易用的标准版本，也有灵活强大的智能版本，满足不同场景的需
求！
