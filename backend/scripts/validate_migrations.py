#!/usr/bin/env python3
"""
è¿ç§»ä¸€è‡´æ€§éªŒè¯è„šæœ¬
æ£€æŸ¥æ¨¡å‹å®šä¹‰ä¸æ•°æ®åº“å®é™…ç»“æ„æ˜¯å¦ä¸€è‡´
"""
import os
import sys
import tempfile
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
backend_dir = Path(__file__).parent.parent
sys.path.insert(0, str(backend_dir))

def validate_migrations():
    """éªŒè¯è¿ç§»ä¸€è‡´æ€§"""
    print("ğŸ” æ£€æŸ¥æ¨¡å‹ä¸æ•°æ®åº“ä¸€è‡´æ€§...")

    # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®åº“URL
    if not os.getenv('DATABASE_URL'):
        print("âŒ é”™è¯¯: è¯·è®¾ç½®DATABASE_URLç¯å¢ƒå˜é‡")
        return False

    # ç”Ÿæˆä¸´æ—¶è¿ç§»æ–‡ä»¶æ£€æŸ¥æ˜¯å¦æœ‰å·®å¼‚
    import subprocess
    try:
        result = subprocess.run([
            'poetry', 'run', 'alembic', 'revision',
            '--autogenerate', '-m', 'temp_validation_check'
        ], cwd=backend_dir, capture_output=True, text=True)

        if result.returncode != 0:
            print(f"âŒ Alembicå‘½ä»¤å¤±è´¥: {result.stderr}")
            return False

        # æŸ¥æ‰¾ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
        versions_dir = backend_dir / 'alembic' / 'versions'
        migration_files = list(versions_dir.glob('*temp_validation_check.py'))

        if not migration_files:
            print("âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶")
            return False

        migration_file = migration_files[0]

        # æ£€æŸ¥è¿ç§»æ–‡ä»¶å†…å®¹
        with open(migration_file, 'r', encoding='utf-8') as f:
            content = f.read()

        # åˆ é™¤ä¸´æ—¶è¿ç§»æ–‡ä»¶
        migration_file.unlink()

        # æ£€æŸ¥æ˜¯å¦åªåŒ…å«passè¯­å¥
        if '# ### commands auto generated by Alembic' in content:
            # æ£€æŸ¥upgradeå’Œdowngradeå‡½æ•°ä¸­æ˜¯å¦åªæœ‰pass
            lines = content.split('\n')
            upgrade_has_content = False
            downgrade_has_content = False

            in_upgrade = False
            in_downgrade = False

            for line in lines:
                stripped = line.strip()

                if 'def upgrade()' in line:
                    in_upgrade = True
                    in_downgrade = False
                    continue
                elif 'def downgrade()' in line:
                    in_upgrade = False
                    in_downgrade = True
                    continue
                elif stripped.startswith('def ') and stripped != 'def upgrade()' and stripped != 'def downgrade()':
                    in_upgrade = False
                    in_downgrade = False
                    continue

                # æ£€æŸ¥å‡½æ•°ä½“ä¸­æ˜¯å¦æœ‰å®é™…çš„DDLæ“ä½œ
                if in_upgrade and stripped and not stripped.startswith('#') and stripped != 'pass' and '# ### end Alembic commands ###' not in stripped and '"""' not in stripped:
                    upgrade_has_content = True

                if in_downgrade and stripped and not stripped.startswith('#') and stripped != 'pass' and '# ### end Alembic commands ###' not in stripped and '"""' not in stripped:
                    downgrade_has_content = True

            if not upgrade_has_content and not downgrade_has_content:
                print("âœ… æ¨¡å‹ä¸æ•°æ®åº“ç»“æ„å®Œå…¨ä¸€è‡´ï¼")
                return True

        print("âš ï¸  æ£€æµ‹åˆ°æ¨¡å‹ä¸æ•°æ®åº“ç»“æ„ä¸ä¸€è‡´!")
        print("ğŸ“ ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶å†…å®¹:")
        print("-" * 50)
        print(content)
        print("-" * 50)
        return False

    except Exception as e:
        print(f"âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™: {e}")
        return False

def check_env_imports():
    """æ£€æŸ¥env.pyæ˜¯å¦å¯¼å…¥äº†æ‰€æœ‰æ¨¡å‹"""
    print("ğŸ” æ£€æŸ¥env.pyæ¨¡å‹å¯¼å…¥...")

    env_file = backend_dir / 'alembic' / 'env.py'
    models_init = backend_dir / 'app' / 'models' / '__init__.py'

    # è¯»å–models/__init__.pyä¸­çš„æ‰€æœ‰æ¨¡å‹
    with open(models_init, 'r', encoding='utf-8') as f:
        models_content = f.read()

    # æå–__all__ä¸­çš„æ¨¡å‹å
    import ast
    tree = ast.parse(models_content)
    all_models = []

    for node in ast.walk(tree):
        if isinstance(node, ast.Assign):
            for target in node.targets:
                if isinstance(target, ast.Name) and target.id == '__all__':
                    if isinstance(node.value, ast.List):
                        for elt in node.value.elts:
                            if isinstance(elt, ast.Str):
                                all_models.append(elt.s)
                            elif isinstance(elt, ast.Constant):
                                all_models.append(elt.value)

    # è¯»å–env.pyå†…å®¹
    with open(env_file, 'r', encoding='utf-8') as f:
        env_content = f.read()

    # æ£€æŸ¥æ˜¯å¦å¯¼å…¥äº†æ‰€æœ‰æ¨¡å‹
    missing_imports = []
    for model in all_models:
        if model == 'Base':  # Baseå·²ç»å•ç‹¬å¯¼å…¥
            continue
        if model not in env_content:
            missing_imports.append(model)

    if missing_imports:
        print(f"âŒ env.pyç¼ºå°‘ä»¥ä¸‹æ¨¡å‹å¯¼å…¥: {missing_imports}")
        return False
    else:
        print("âœ… env.pyå·²å¯¼å…¥æ‰€æœ‰æ¨¡å‹ï¼")
        return True

if __name__ == '__main__':
    print("ğŸš€ å¼€å§‹è¿ç§»ä¸€è‡´æ€§éªŒè¯...")
    print()

    # æ£€æŸ¥env.pyå¯¼å…¥
    env_ok = check_env_imports()
    print()

    # æ£€æŸ¥è¿ç§»ä¸€è‡´æ€§
    migration_ok = validate_migrations()
    print()

    if env_ok and migration_ok:
        print("ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼æ¨¡å‹ä¸è¿ç§»å®Œå…¨ä¸€è‡´ã€‚")
        sys.exit(0)
    else:
        print("âŒ å‘ç°é—®é¢˜ï¼Œè¯·ä¿®å¤åé‡æ–°éªŒè¯ã€‚")
        sys.exit(1)