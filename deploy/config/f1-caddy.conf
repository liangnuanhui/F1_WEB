# F1 Web Application Caddy Configuration
# 添加到现有 /etc/caddy/Caddyfile 中

# --------------------------------------------------
# F1 Web应用配置
# --------------------------------------------------
f1.251125.xyz {
    # 处理API请求
    handle /api/* {
        reverse_proxy localhost:8000 {
            # 健康检查
            health_uri /api/v1/health
            health_interval 30s
            health_timeout 5s

            # 请求头优化
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # 处理前端应用 - 静态文件服务
    handle /* {
        root * /var/www/f1-web/frontend/dist
        file_server

        # SPA支持 - 所有路由都返回index.html
        try_files {path} /index.html
    }

    # 启用压缩
    encode gzip

    # 静态资源缓存
    handle_path /static/* {
        header Cache-Control "public, max-age=31536000"
    }

    # 安全头配置
    header {
        # XSS保护
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"

        # HSTS (可选，如果需要强制HTTPS)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # 隐藏服务器信息
        -Server
    }

    # 日志配置
    log {
        output file /var/log/caddy/f1.251125.xyz.log {
            roll_size 100mb
            roll_keep 5
        }
    }
}

# --------------------------------------------------
# 可选：Flower监控面板 (开发/调试用)
# 生产环境建议使用VPN或IP限制访问
# --------------------------------------------------
# monitor.251125.xyz {
#     reverse_proxy localhost:5555 {
#         # 基础认证
#         basicauth {
#             admin $2a$14$hashed_password_here
#         }
#     }
# }